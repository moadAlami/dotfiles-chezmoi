#!/usr/bin/zsh
source /home/mouad/.config/env

if [[ -n $WAYLAND_DISPLAY ]]; then
	radio=$(echo -e 'private\nclassic' | rofi -dmenu -i -l 2 -p "Choose a radio")
elif [[ -n $DISPLAY ]]; then
	radio=$(echo -e 'private\nclassic' | dmenu -i -l 2 -p "Choose a radio")
fi


url="https://live.musopen.org:8085/streamvbr0"

if [[ $radio == 'private' ]]; then
	url="https://radio.mouadalami.xyz"

	if [[ -z $SERVERUSER || -z $SERVERPASS ]]; then
		notify-send "Missing SERVERUSER or SERVERPASS env variables"
		exit 1
	fi

	if ! curl -u "${SERVERUSER}:${SERVERPASS}" --silent --head "$url" | grep -q "200 OK"; then
		notify-send "Login failed or stream unavailable"
		exit 1
	fi

	auth_header=$(echo -n "${SERVERUSER}:${SERVERPASS}" | base64)
	echo "$radio"
	pkill -f "$url" || st -e mpv --http-header-fields="Authorization: Basic $auth_header" "$url"
	exit 0
fi

if [[ $radio == 'classic' ]]; then
	echo "$radio"
	pkill -f "$url" || st -e mpv "$url"
fi
